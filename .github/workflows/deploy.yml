name: Deploy to Hostinger (Zero Downtime - Production Ready)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: üöÄ Deploy Laravel Zero Downtime (Production)
    runs-on: ubuntu-latest

    steps:
      # ================================
      # 1Ô∏è‚É£ Checkout Repository
      # ================================
      - name: üì• Checkout Repository
        uses: actions/checkout@v3

      # ================================
      # 2Ô∏è‚É£ Deploy via SSH
      # ================================
      - name: üîê Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_NAME }}
          username: ${{ secrets.HOST_USER }}
          key: ${{ secrets.HOST_SSH_KEY }}
          port: 65002
          timeout: 60s
          command_timeout: 20m
          script_stop: true
          debug: false
          script: |
            set -e
            echo "üöÄ Starting Zero Downtime Deployment..."

            # ================================
            # 2.1 Paths
            # ================================
            DOMAIN_PATH=/home/u595038546/domains/csr.majubersamaadp.com
            RELEASES_PATH=$DOMAIN_PATH/releases
            SHARED_PATH=$DOMAIN_PATH/shared
            CURRENT_PATH=$DOMAIN_PATH/current

            TIMESTAMP=$(date +"%Y%m%d%H%M%S")
            NEW_RELEASE=$RELEASES_PATH/release_$TIMESTAMP

            # ================================
            # 1Ô∏è‚É£ Prepare Directory Structure
            # ================================
            mkdir -p $RELEASES_PATH
            mkdir -p $SHARED_PATH/storage/framework/{sessions,views,cache}
            mkdir -p $SHARED_PATH/storage/app/public
            mkdir -p $SHARED_PATH/bootstrap/cache
            mkdir -p $SHARED_PATH/frontend/data_warga/kk
            mkdir -p $SHARED_PATH/frontend/data_warga/ktp

            # ================================
            # 2Ô∏è‚É£ Clone Repository (Lightweight)
            # ================================
            git clone --depth 1 https://github.com/Septian4r1/w_connect.git $NEW_RELEASE
            cd $NEW_RELEASE

            # ================================
            # 3Ô∏è‚É£ Install Dependencies (Optimized)
            # ================================
            if [ -f composer.json ]; then
              composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
            fi

            # ================================
            # 4Ô∏è‚É£ Shared .env & Storage Symlink
            # ================================
            if [ ! -f $SHARED_PATH/.env ]; then
              echo "‚ö†Ô∏è .env not found. Creating from example..."
              cp .env.example $SHARED_PATH/.env
            fi

            rm -rf storage
            ln -sfn $SHARED_PATH/storage storage
            ln -sfn $SHARED_PATH/.env .env
            chmod -R 775 storage bootstrap/cache || true

            # ================================
            # 5Ô∏è‚É£ Force Clear Old Cached Config (ANTI BUG)
            # ================================
            rm -f bootstrap/cache/*.php || true
            php artisan config:clear || true
            php artisan route:clear || true
            php artisan view:clear || true

            # ================================
            # 6Ô∏è‚É£ Database Migration
            # ================================
            php artisan migrate --force || echo "‚ö†Ô∏è Migration skipped"

            # ================================
            # 7Ô∏è‚É£ Rebuild Optimized Cache
            # ================================
            php artisan config:cache || true
            php artisan route:cache || true
            php artisan view:cache || true

            # ================================
            # 8Ô∏è‚É£ Storage Link (Public Storage)
            # ================================
            php artisan storage:link || true

            # ================================
            # 8.5Ô∏è‚É£ Shared Data Warga Symlink
            # ================================
            # Pastikan setiap release baru menggunakan shared folder untuk KK/KTP
            rm -rf frontend/data_warga
            ln -sfn $SHARED_PATH/frontend/data_warga frontend/data_warga
            echo "üîó Symlink frontend/data_warga ‚Üí shared folder dibuat"

            # ================================
            # 9Ô∏è‚É£ Zero Downtime Symlink Switch
            # ================================
            ln -sfn $NEW_RELEASE $CURRENT_PATH
            ln -sfn $CURRENT_PATH/public $DOMAIN_PATH/public_html
            echo "üü¢ Symlink current/public ‚Üí public_html sudah diupdate"

            # ================================
            # üîü Keep Only 2 Latest Releases
            # ================================
            cd $RELEASES_PATH
            ls -dt release_* | tail -n +3 | xargs rm -rf || true
            echo "üóëÔ∏è Old releases cleanup done"

            echo "‚úÖ Deployment Completed Successfully!"

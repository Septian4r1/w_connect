name: Deploy to Hostinger (Zero Downtime - Optimized)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: üöÄ Deploy Laravel Zero Downtime (Shared Optimized)
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v3

      - name: üîê Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_NAME }}
          username: ${{ secrets.HOST_USER }}
          key: ${{ secrets.HOST_SSH_KEY }}
          port: 65002
          timeout: 60s
          command_timeout: 20m
          script_stop: true
          debug: false
          script: |
            set -e

            DOMAIN_PATH=/home/u595038546/domains/csr.majubersamaadp.com
            RELEASES_PATH=$DOMAIN_PATH/releases
            SHARED_PATH=$DOMAIN_PATH/shared
            CURRENT_PATH=$DOMAIN_PATH/current

            TIMESTAMP=$(date +"%Y%m%d%H%M%S")
            NEW_RELEASE=$RELEASES_PATH/release_$TIMESTAMP

            echo "üöÄ Starting Optimized Deployment..."

            mkdir -p $RELEASES_PATH
            mkdir -p $SHARED_PATH/storage
            mkdir -p $SHARED_PATH/storage/framework/{sessions,views,cache}
            mkdir -p $SHARED_PATH/bootstrap/cache

            # ==============================
            # 1Ô∏è‚É£ Clone ringan (lebih cepat & hemat resource)
            # ==============================
            git clone --depth 1 https://github.com/Septian4r1/w_connect.git $NEW_RELEASE
            cd $NEW_RELEASE

            # ==============================
            # 2Ô∏è‚É£ Install dependency (lebih aman)
            # ==============================
            if [ -f composer.json ]; then
              composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist || true
            fi

            # ==============================
            # 3Ô∏è‚É£ Shared ENV & Storage
            # ==============================
            if [ ! -f $SHARED_PATH/.env ]; then
              echo "‚ö†Ô∏è .env not found, copying from example..."
              cp .env.example $SHARED_PATH/.env
            fi

            rm -rf storage
            ln -sfn $SHARED_PATH/storage storage
            ln -sfn $SHARED_PATH/.env .env

            chmod -R 775 storage bootstrap/cache || true

            # ==============================
            # 4Ô∏è‚É£ Laravel Optimization
            # ==============================
            php artisan config:clear || true
            php artisan cache:clear || true
            php artisan route:clear || true
            php artisan view:clear || true

            php artisan migrate --force || echo "‚ö†Ô∏è Migration skipped"

            php artisan config:cache || true
            php artisan route:cache || true
            php artisan view:cache || true

            # ==============================
            # 5Ô∏è‚É£ Zero Downtime Switch
            # ==============================
            ln -sfn $NEW_RELEASE $CURRENT_PATH
            ln -sfn $CURRENT_PATH/public $DOMAIN_PATH/public_html

            # ==============================
            # 6Ô∏è‚É£ Simpan hanya 2 release terbaru
            # ==============================
            cd $RELEASES_PATH
            ls -dt release_* | tail -n +3 | xargs rm -rf || true

            echo "‚úÖ Deployment Completed Successfully!"

name: Deploy to Hostinger

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: üöÄ Deploy Laravel App
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v3

      - name: üîê Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_NAME }}
          username: ${{ secrets.HOST_USER }}
          key: ${{ secrets.HOST_SSH_KEY }}
          port: 65002
          script_stop: true
          script: |
            set -e

            DOMAIN_PATH=/home/u595038546/domains/csr.majubersamaadp.com
            APP_PATH=$DOMAIN_PATH/w_connect

            echo "üöÄ Starting Fresh Deployment..."

            cd $DOMAIN_PATH

            # ================================
            # 1Ô∏è‚É£ Hapus total folder lama (fresh start)
            # ================================
            rm -rf w_connect
            rm -rf public_html

            # ================================
            # 2Ô∏è‚É£ Clone ulang repository
            # ================================
            git clone https://github.com/Septian4r1/w_connect.git w_connect
            cd w_connect

            # ================================
            # 3Ô∏è‚É£ Install composer
            # ================================
            composer install --no-dev --optimize-autoloader

            # ================================
            # 4Ô∏è‚É£ Setup Laravel
            # ================================
            php artisan key:generate || true
            php artisan migrate --force || true

            mkdir -p storage/framework/{sessions,views,cache}
            mkdir -p bootstrap/cache
            chmod -R 775 storage bootstrap/cache || true

            php artisan storage:link || true

            php artisan config:clear || true
            php artisan cache:clear || true
            php artisan route:clear || true
            php artisan view:clear || true
            php artisan config:cache
            php artisan route:cache

            # ================================
            # 5Ô∏è‚É£ Set public_html ke public Laravel
            # ================================
            cd $DOMAIN_PATH
            ln -s w_connect/public public_html

            echo "‚úÖ Fresh Deployment Completed!"

name: Deploy to Hostinger (Zero Downtime)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: üöÄ Deploy Laravel Zero Downtime
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v3

      - name: üîê Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_NAME }}
          username: ${{ secrets.HOST_USER }}
          key: ${{ secrets.HOST_SSH_KEY }}
          port: 65002
          script_stop: true
          script: |
            set -e

            DOMAIN_PATH=/home/u595038546/domains/csr.majubersamaadp.com
            RELEASES_PATH=$DOMAIN_PATH/releases
            SHARED_PATH=$DOMAIN_PATH/shared
            CURRENT_PATH=$DOMAIN_PATH/current

            TIMESTAMP=$(date +"%Y%m%d%H%M%S")
            NEW_RELEASE=$RELEASES_PATH/release_$TIMESTAMP

            echo "üöÄ Starting Zero Downtime Deployment..."

            mkdir -p $RELEASES_PATH
            mkdir -p $SHARED_PATH/storage

            # ==============================
            # 1Ô∏è‚É£ Clone ke folder release baru
            # ==============================
            git clone https://github.com/Septian4r1/w_connect.git $NEW_RELEASE
            cd $NEW_RELEASE

            # ==============================
            # 2Ô∏è‚É£ Install dependency
            # ==============================
            composer install --no-dev --optimize-autoloader

            # ==============================
            # 3Ô∏è‚É£ Shared File (.env & storage)
            # ==============================
            if [ ! -f $SHARED_PATH/.env ]; then
              echo "‚ö†Ô∏è .env not found, copying from example..."
              cp .env.example $SHARED_PATH/.env
            else
              echo "‚úÖ Using existing .env"
            fi

            rm -rf storage
            ln -sfn $SHARED_PATH/storage storage
            ln -sfn $SHARED_PATH/.env .env

            # ==============================
            # 4Ô∏è‚É£ Laravel Setup (FIXED VERSION)
            # ==============================

            php artisan config:clear || true

            php artisan migrate --force || echo "‚ö†Ô∏è Migration skipped"

            php artisan cache:clear || true
            php artisan route:clear || true
            php artisan view:clear || true

            php artisan config:cache || true
            php artisan route:cache || true

            # ==============================
            # 5Ô∏è‚É£ Switch Symlink (ZERO DOWNTIME)
            # ==============================
            ln -sfn $NEW_RELEASE $CURRENT_PATH
            ln -sfn $CURRENT_PATH/public $DOMAIN_PATH/public_html

            # ==============================
            # 6Ô∏è‚É£ Hapus release lama (simpan 5 versi)
            # ==============================
            cd $RELEASES_PATH
            ls -dt release_* | tail -n +6 | xargs rm -rf || true

            echo "‚úÖ Deployment Completed Successfully!"

services:
  # -------------------------------
  # 1) PHP-FPM Laravel App
  # -------------------------------
  w_connect-app:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: w_connect-app

    # Mount source code + vendor + storage
    volumes:
      - ./:/var/www/html:cached
      - vendor_data:/var/www/html/vendor
      - storage_data:/var/www/html/storage

    # Override env database agar sesuai docker
    environment:
      DB_CONNECTION: mysql
      DB_HOST: w_connect          # HARUS nama service DB
      DB_PORT: 3306
      DB_DATABASE: management
      DB_USERNAME: management
      DB_PASSWORD: managementpass

    depends_on:
      - w_connect

    networks:
      - management_net

    restart: unless-stopped


  # -------------------------------
  # 2) Laravel Queue Worker
  # -------------------------------
  w_connect-worker:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: w_connect-worker
    command: supervisord -c /etc/supervisor/conf.d/supervisord.conf

    volumes:
      - ./:/var/www/html:cached
      - vendor_data:/var/www/html/vendor
      - storage_data:/var/www/html/storage

    depends_on:
      - w_connect-app

    networks:
      - management_net

    restart: unless-stopped


  # -------------------------------
  # 3) Nginx Reverse Proxy
  # -------------------------------
  w_connect-nginx:
    image: nginx:1.25-alpine
    container_name: w_connect-nginx

    ports:
      - "8080:80"

    volumes:
      - ./:/var/www/html:cached
      - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - storage_data:/var/www/html/storage

    depends_on:
      - w_connect-app

    networks:
      - management_net

    restart: unless-stopped


  # -------------------------------
  # 4) MariaDB Database
  # -------------------------------
  w_connect:
    image: mariadb:10.6
    container_name: w_connect
    command: --default-authentication-plugin=mysql_native_password

    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: management
      MYSQL_USER: management
      MYSQL_PASSWORD: managementpass

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-uroot", "-prootpass"]
      interval: 5s
      timeout: 5s
      retries: 20

    ports:
      - "3308:3306"   # host:container

    volumes:
      - management_db_data:/var/lib/mysql

    networks:
      - management_net

    restart: unless-stopped


  # -------------------------------
  # 5) phpMyAdmin
  # -------------------------------
  w_connect-phpmyadmin:
    image: phpmyadmin:5.2
    container_name: w_connect-phpmyadmin

    environment:
      PMA_HOST: w_connect
      PMA_USER: management
      PMA_PASSWORD: managementpass
      UPLOAD_LIMIT: 64M

    ports:
      - "8081:80"

    depends_on:
      - w_connect

    networks:
      - management_net

    restart: unless-stopped


# -------------------------------
# Persistent Volumes
# -------------------------------
volumes:
  management_db_data:
  vendor_data:
  storage_data:


# -------------------------------
# Network
# -------------------------------
networks:
  management_net:
    driver: bridge
